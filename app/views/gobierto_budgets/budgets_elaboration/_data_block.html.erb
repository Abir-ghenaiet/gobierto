<div class="block">
  <h2 class="with_description"><%= t('gobierto_budgets.budgets_elaboration.index.metric_boxes_data') %></h2>
  <p><%= t('gobierto_budgets.budgets_elaboration.index.metric_boxes_data_description') %></p>

  <div class="tabs m_v_2">
    <ul role="tablist" aria-label="<%= t('gobierto_budgets.budgets_elaboration.index.explore_the_detail') %>">
      <li role="presentation" class="<%= class_if("active", @kind == GobiertoBudgets::BudgetLine::INCOME) %>">
        <%= link_to(t('gobierto_budgets.budget_lines.explorer.income'), gobierto_budgets_budgets_elaboration_path(kind: GobiertoBudgets::BudgetLine::INCOME), remote: true) %>
      </li>
      <li role="presentation" class="<%= class_if("active", @kind == GobiertoBudgets::BudgetLine::EXPENSE) %>">
        <%= link_to(t('gobierto_budgets.budget_lines.explorer.expenses'), gobierto_budgets_budgets_elaboration_path(kind: GobiertoBudgets::BudgetLine::EXPENSE), remote: true) %>
      </li>
    </ul>
  </div>

  <div class="pure-g metric_boxes">

    <div class="pure-u-1-1 metric_box">
      <div class="highlight-proposal">
        <p><span>&#9632;</span><%= t('gobierto_budgets.budgets_elaboration.index.next_year_proposal', year: @year) %></p>
      </div>
    </div>

    <div class="pure-u-1-2 pure-u-md-1-5 metric_box">
      <!--  metric_box should be flexbox -->
      <div class="inner" style="margin-left:0;">
        <h3><%= t('gobierto_budgets.budgets_elaboration.index.expenses_per_inhabitant') %></h3>
        <div class="metric"><%= format_currency @site_stats.total_budget_per_inhabitant %></div>
        <div class="diff">+ 3,45% vs 2017</div>
      </div>
    </div>

    <div class="pure-u-1-2 pure-u-md-1-5 metric_box">
      <div class="inner">
        <h3><%= t('gobierto_budgets.budgets_elaboration.index.total_expenses') %></h3>
        <div class="metric"><%= format_currency @site_stats.total_budget %></div>
        <div class="diff">+ 3,45% vs 2017</div>
      </div>
    </div>

    <div class="pure-u-1-2 pure-u-md-1-5 metric_box">
      <div class="inner">
        <h3><%= t('gobierto_budgets.budgets_elaboration.index.executed') %> (<span class="tooltiped" title="<%= t('gobierto_budgets.budgets_elaboration.index.executed_tooltip') %>">?</span>)</h3>
        <% if @site_stats.total_budget_executed %>
          <div class="metric">
            <%= link_to gobierto_budgets_budgets_elaboration_path(year: GobiertoBudgets::SearchEngineConfiguration::Year.last) do %>
              <%= format_currency @site_stats.total_budget_executed %>
            <% end %>
          </div>

          <div class="explanation_bar">
            <% percentage = @site_stats.total_budget_executed_percentage %>
            <% percentage_bar_width = percentage > 100 ? 100 : percentage %>
            <div class="bar"><div class="line" style="width: <%= percentage_bar_width %>%"></div></div>
            <span><%= t('gobierto_budgets.budgets_elaboration.index.executed_percent', percentage: percentage) %></span>
          </div>
        <% else %>
          <% percentage = @site_stats.total_budget_executed_percentage(@year - 1) %>
          <div class="metric"><span class="not_av"><%= t('gobierto_budgets.budgets_elaboration.index.not_available_short') %></span></div>
          <div class="explanation">
            <%= t('gobierto_budgets.budgets_elaboration.index.executed_percent_other_year_html', year: @year - 1, link: link_to("#{percentage} %", gobierto_budgets_budgets_elaboration_path)) %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="pure-u-1-2 pure-u-md-1-5 metric_box">
      <div class="inner">
        <h3><%= t('gobierto_budgets.budgets_elaboration.index.inhabitants') %></h3>
        <div class="metric"><%= number_with_precision @site_stats.latest_available(:population, @year)[:value], precision: 0, delimiter: '.' %></div>
        <% if @site_stats.latest_available(:population, @year)[:year] != @year %>
          <div class="explanation">
            <%= t('gobierto_budgets.budgets_elaboration.index.data_of_year', year: @site_stats.latest_available(:population, @year)[:year]) %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="pure-u-1-2 pure-u-md-1-5 metric_box">
      <div class="inner">
        <h3><%= t('gobierto_budgets.budgets_elaboration.index.debt') %></h3>
        <div class="metric"><%= format_currency @site_stats.latest_available(:debt, @year)[:value] %></div>
        <% if @site_stats.latest_available(:debt, @year)[:year] != @year %>
          <div class="explanation">
            <%= t('gobierto_budgets.budgets_elaboration.index.at_years_end', year: @site_stats.latest_available(:debt, @year)[:year])%>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<div class="block">

  <div class="pure-menu pure-menu-horizontal pure-menu-horizontal--custom">
    <ul class="pure-menu-list">
      <% pending do %>
        <li class="pure-menu-item <%= class_if("active", @area_name == GobiertoBudgets::CustomArea.area_name) %>">
          <%= link_to(t('gobierto_budgets.budgets_elaboration.index.by_custom_category'), gobierto_budgets_budgets_elaboration_path(kind: @kind, area_name: GobiertoBudgets::CustomArea.area_name), remote: true, class: 'pure-menu-link') %>
        </li>
      <% end %>
      <% if @kind == GobiertoBudgets::BudgetLine::EXPENSE %>
        <li class="pure-menu-item <%= class_if("active", @area_name == GobiertoBudgets::EconomicArea.area_name) %>">
          <%= link_to(t('gobierto_budgets.budgets_elaboration.index.by_economic_expense'), gobierto_budgets_budgets_elaboration_path(kind: @kind, area_name: GobiertoBudgets::EconomicArea.area_name), remote: true, class: 'pure-menu-link') %>
        </li>
        <li class="pure-menu-item <%= class_if("active", @area_name == GobiertoBudgets::FunctionalArea.area_name) %>">
          <%= link_to(t('gobierto_budgets.budgets_elaboration.index.by_functional_expense'), gobierto_budgets_budgets_elaboration_path(kind: @kind, area_name: GobiertoBudgets::FunctionalArea.area_name), remote: true, class: 'pure-menu-link') %>
        </li>
      <% else %>
        <li class="pure-menu-item <%= class_if("active", @area_name == GobiertoBudgets::EconomicArea.area_name) %>">
          <%= link_to(t('gobierto_budgets.budgets_elaboration.index.by_economic_income'), gobierto_budgets_budgets_elaboration_path(kind: @kind, area_name: GobiertoBudgets::EconomicArea.area_name), remote: true, class: 'pure-menu-link') %>
        </li>
      <% end %>
    </ul>
  </div>

  <% if @interesting_expenses.any? %>
    <div class="graph" id="treemap" data-url="<%= gobierto_budgets_budget_lines_treemap_path(@year, kind: @kind, area_name: @area_name, level: 2, format: :json) %>"></div>
  <% end %>

  <% if @interesting_expenses.any? %>
    <table class="explore_slow">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th class="highlight-proposal" colspan="4">
            <p style="text-align:left"><span>&#9632;</span><%= t('gobierto_budgets.budgets_elaboration.index.next_year_proposal', year: @year) %></p>
          </th>
        </tr>
        <tr>
          <th></th>
          <th></th>
          <th class="highlight-proposal"><%= t('gobierto_budgets.budgets_elaboration.index.category_value') %></th>
          <th class="highlight-proposal" colspan="2"><%= t('gobierto_budgets.budgets_elaboration.index.category_percentage') %></th>
          <th class="highlight-proposal"><%= t('gobierto_budgets.budgets_elaboration.index.diff_previous_year', year: @year - 1) %></th>
        </tr>
      </thead>

      <tbody>
        <% @interesting_expenses.group_by(&:parent_code).each do |parent_code, budget_lines| %>
          <tr class="group">
            <td class="level_1" rowspan="<%= budget_lines.count %>">
              <%= budget_line_denomination @area_name, parent_code, @kind %>
            </td>
            <%= render partial: "gobierto_budgets/budgets/sub_budget_line", locals: {sub_budget_line: budget_lines.first, last_item: false} %>
          </tr>
          <% budget_lines[1..-1].each_with_index do |budget_line, i| %>
            <tr>
              <%= render partial: "gobierto_budgets/budgets/sub_budget_line", locals: {sub_budget_line: budget_line, last_item: (i == budget_lines.length - 2)} %>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p><%= t('gobierto_budgets.budgets_elaboration.index.no_data') %></p>
  <% end %>
</div>
