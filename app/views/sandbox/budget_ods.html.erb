
<div class="column">

  <div id="taxes_receipt" class="block">
    <div class="pure-g header_block_inline m_b_1">
      <div class="pure-u-1 pure-u-md-12-24">
        <h2 class="with_description">Objetivos de Desarrollo Sostenible</h2>
        <p>En septiembre de 2015 la Asamblea General de las Naciones Unidas, aprobó la resolución "Transformar nuestro mundo: la Agenda 2030 para el Desarrollo Sostenible" que establece un plan de acción con objetivos y metas claras "a favor de las personas, el planeta y la prosperidad. Esta agenda se resume en 17 Objetivos y 169 metas que conjugan todas las dimensiones del desarrollo sostenible (la ambiental, la económica y la social) necesitando la colaboración de "todos los paises, todas las partes interesadas y todas las personas.</p>

        <p>El ámbito Local se define como un espacio clave por lo tanto para contribuir a la consecución de los Objetivos de Desarrollo Sostenible. Ese es el compromiso de la Diputación Provincial de Huelva que en un ejercicio de acercar lo Global a lo Local,  ha alineado sus presupuestos 2019 con el cumplimiento de los 17 ODS. Es un primer paso que desvela el compromiso de esta Institución y su alienación con el futuro: la Agenda 2030.</p>

      </div>

      <div class="pure-u-1 pure-u-md-12-24 right">
        <%= image_tag('ods/S_SDG_logo_No_Emblem_square_rgb.png', class: 'medium_img') %>
      </div>

    </div>
  </div>

  <div class="tabs m_v_2">
    <ul role="tablist" aria-label="Consulta los ODS">
      <li role="presentation" class="active">
        <a data-remote="true" href="">Por ODS</a>
      </li>
      <li role="presentation" class="">
        <a data-remote="true" href="">Por Programa</a>
      </li>
    </ul>
  </div>

  <% for i in ["01","02","03","04","05","07","08","09","10","11","13","15","16","17"] %>
    <div class="m_v_2 card-container">
      <div class="card-inner-side"><%= image_tag('ods/goals_icons-individual-rgb-' + i + '.png') %></div>
      <div class="card-inner-content p_2" id="chart-<%= i.to_i %>">
        <%= i %>
      </div>
    </div>
  <% end %>

  <h2 class="with_description">Resumen</h2>

  <p>TABLA</p>


</div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script type="text/javascript">

function barChart(id, data) {
  function round(value, decimals) {
    return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
  }

  function format(value){
    value = parseFloat(value);
    if(value > 1000000) {
      return round(value / 1000000, 2).toLocaleString() + " M€";
    } else {
      return round(value, 2).toLocaleString() + " €";
    }
  }
  let margin = {top: 20, right: 20, bottom: 30, left: 290};
  let height = data.length * 25 + margin.top + margin.bottom;

  let bodySelection = d3.select(`#${id}`)
  bodySelection.html('')
  let svg = bodySelection.append("svg").attr("width", 850).attr("height", height),
    width = +svg.attr("width") - margin.left - margin.right


  let x = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.value)])
      .range([margin.left, width - margin.right]);

  let y = d3.scaleBand()
      .domain(data.map(d => d.key))
      .range([margin.top, height - margin.bottom])
      .padding(0.1);

  let xAxis = g => g
      .attr("transform", `translate(0,${margin.top})`)
      .call(d3.axisTop(x).ticks(4).tickFormat(d => d > 0 ? format(d) : d))
      .call(g => g.select(".domain").remove());

  let yAxis = g => g
      .attr("transform", `translate(${margin.left},0)`)
      .call(d3.axisLeft(y).tickSizeOuter(0))

  let g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")

  svg.append("g")
      .attr("fill", "steelblue")
    .selectAll("rect")
    .data(data)
    .join("rect")
      .attr("x", x(0))
      .attr("y", d => y(d.key))
      .attr("width", d => x(d.value) - x(0))
      .attr("height", y.bandwidth());

  svg.append("g")
      .attr("text-anchor", "end")
      .style("font", "12px sans-serif")
    .selectAll("text")
    .data(data)
    .join("text")
      .attr("fill", d => (x(d.value) - x(0)) > 70 ? "white" : "steelblue" )
      .attr("x", d => (x(d.value) - x(0)) > 70 ? x(0) + 80 : x(d.value) + 60)
      .attr("y", d => y(d.key) + y.bandwidth() / 2)
      .attr("dy", "0.35em")
      .text(d => format(d.value));

  svg.append("g")
      .call(xAxis);

  svg.append("g")
      .call(yAxis);
}


d3.csv("/ods-huelva.csv").then(function(rawData){
  var exclude = [6, 12, 14];
  var total = 17;

  for(var i=1; i <= total; i++){
    console.log(i);
    if(exclude.indexOf(i) !== -1){ continue; }
    var data = [];
    for(var j = 1; j <= total; j++){
      if(rawData[j][i] !== ""){
        data.push({key: rawData[j][""], value: parseFloat(rawData[j][i])});
      }
    }
    barChart("chart-" + i, data);
  }
});

</script>
