<div class="admin_breadcrumb">
  <%= link_to t("gobierto_admin.welcome.index.title"), admin_root_path %> »
  <%= link_to t(".sections"), admin_cms_sections_path %>
  <%= link_to @section.title, admin_cms_section_path(@section) %>
</div>

<h1><%= @section.title %></h1>

<div class="admin_tools right">
  <%= link_to '<i class="fa fa-cog"></i> Configuración'.html_safe, edit_admin_cms_section_path(@section), class: 'open_remote_modal' %>
</div>

<div class="pure-g">

  <div class="pure-u-1 pure-u-md-1-2 p_h_r_2">
    <div id="tree1"></div>
  </div>

  <div class="pure-u-1 pure-u-md-1-2">

    <div class="form_item input_text">
      <label for="name"><%= t('.select_page') %></label>
      <input type="text" placeholder="<%= t('.placeholders.search') %>" name="q" id="gobierto_search" data-autocomplete="<%= admin_cms_section_pages_path(@section, format: :js) %>" element_id="#pages" />
    </div>

    <h3><%= t('.last_edited_pages') %></h3>

    <div class="activity_feed section_editor">
      <%= render 'pages_filter' %>
    </div>
  </div>
</div>

<script type="text/javascript">
  window.searchClient = {
    client: algoliasearch('<%= Rails.application.secrets.algolia_application_id %>', '<%= Rails.application.secrets.algolia_search_api_key %>'),
    indexes: ["<%= GobiertoCms::Page.search_index_name %>"],
    filters: "site_id:<%= algolia_search_client.site.id %>"
  };

  $(function() {
    var $tree = $('#tree1');
    $.getJSON(
        '/admin/cms/sections/' + <%= params[:id] %> + '/section_items',
        function(data) {
            $('#tree1').tree({
                data: data['section_items'],
                autoOpen: true,
                dragAndDrop: true,
                onCreateLi: function(node, $li) {
                    // Append a link to the jqtree-element div.
                    // The link has an url '#node-[id]' and a data property 'node-id'.
                    $li.find('.jqtree-element').append(
                        '<a remote=true href="#node-'+ node.id +'" class="edit" data-node-id="'+
                        node.id +'"> delete</a>'
                    );
                }
            });
        }
    );

    // Handle a click on the edit link
    $tree.on(
        'click', '.edit',
        function(e) {
            // Get the id from the 'node-id' data property
            var node_id = $(e.target).data('node-id');

            // Get the node from the tree
            var node = $tree.tree('getNodeById', node_id);

            if (node) {
                // Display the node name
                alert(node.name);
                $tree.tree('removeNode', node);
            }
            return false;
        }
    );
  });

  $(document).ready(function(){
    //defino los elementos que se pueden arrastrar
    $(".tipsit").draggable({ revert: true });

    $("#tree1").droppable({
      drop: function( event, ui ) {
        $('#tree1').tree(
          'appendNode',
          {
              name: ui.draggable.attr("data_title"),
              id: ui.draggable.attr("data_id")
          }
        );
        $.ajax({
           url: '/admin/cms/sections/' + <%= params[:id] %> + '/section_items',
           type: 'POST',
           dataType: 'json',
           data: {page_id: ui.draggable.attr("data_id")},
           success:function(data){

           },
           error:function(data){

           }
       });
      }
    });
  })
</script>
