<template>
  <div v-if="datasetId">
    <Caret
      :rotate="showViz"
      @click.native="handleToggle"
    />
    <router-link
      :to="{ path:`/datos/${slug}`, params: { activeSidebarTab: 1 }}"
      class="gobierto-data-title-dataset gobierto-data-title-dataset-big"
    >
      {{ name }}
    </router-link>
    <div v-show="showViz">
      <div
        class="gobierto-data-summary-header-description"
        v-html="description"
      />
      <VisualizationsGrid
        v-if="publicVisualizations"
        :public-visualizations="publicVisualizations"
        :slug="slug"
      />
    </div>
  </div>
</template>
<script>
import { VisualizationFactoryMixin } from "./../../../lib/factories/visualizations";
import { DataFactoryMixin } from "./../../../lib/factories/data";
import { QueriesFactoryMixin } from "./../../../lib/factories/queries";
import { convertToCSV } from "./../../../lib/helpers";
import VisualizationsGrid from "./VisualizationsGrid";
import Caret from "./../commons/Caret";
export default {
  name: "VisualizationsAllList",
  components: {
    VisualizationsGrid,
    Caret
  },
  mixins: [
    VisualizationFactoryMixin,
    DataFactoryMixin,
    QueriesFactoryMixin
  ],
  props: {
    datasetId: {
      type: String,
      default: ''
    },
    slug: {
      type: String,
      default: ''
    },
    name: {
      type: String,
      default: ''
    },
    description: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      publicVisualizations: [],
      showViz: true
    }
  },
  mounted() {
    this.getPublicVisualizations()
  },
  methods: {
    handleToggle() {
      this.showViz = !this.showViz
    },
    async getPublicVisualizations() {
      const { data: response } = await this.getVisualizations({
        "filter[dataset_id]": this.datasetId
      });
      const { data } = response;

      if (data.length) {
        this.publicVisualizations = await this.getDataFromVisualizations(data);
      }
    },
    async getDataFromVisualizations(data) {
      const visualizations = [];
      for (let index = 0; index < data.length; index++) {
        const { attributes = {}, id } = data[index];
        const { query_id, user_id, sql = "", spec = {}, name = "", privacy_status = "open" } = attributes;

        let queryData = null;

        if (query_id) {
          // Get my queries, if they're stored
          const { data } = await this.getQuery(query_id);
          queryData = data;
        } else {
          // Otherwise, run the sql
          const { sql } = attributes;
          const { data } = await this.getData({ sql });
          queryData = data;
        }

        let items = ''
        if (typeof(queryData) === 'object') {
          items = convertToCSV(queryData.data)
        } else {
          items = queryData
        }

        // Append the visualization configuration
        const visualization = { items, config: spec, name, privacy_status, query_id, id, user_id, sql };

        visualizations.push(visualization);

      }

      return visualizations;
    },
  }
};
</script>
